<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff Dashboard</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="bg-light">

<div class="container mt-4 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Staff Dashboard</h3>
    <a href="/logout" class="btn btn-secondary">Logout</a>
  </div>
  <img src="/static/images/staffpage.png" alt="images" class="img-fluid mb-4" />
  <!-- Step 1: GPS Validation -->
  <div class="card p-3 mb-3">
    <h5>Step 1: GPS Validation</h5>
    <button id="btn-gps" class="btn btn-primary w-100 mb-2">Get Current Location</button>
    <div id="gps-status" class="mt-3"></div>
  </div>

  <!-- Step 2: Email OTP Verification -->
  <div class="card p-3 mb-3">
    <h5>Step 2: Email OTP Verification</h5>
    <button id="btn-send-otp" class="btn btn-primary w-100 mb-2" disabled>Send OTP</button>
    <input type="text" id="otp-input" class="form-control mt-2" placeholder="Enter OTP" disabled />
    <button id="btn-verify-otp" class="btn btn-success w-100 mt-2" disabled>Verify OTP</button>
    <div id="otp-status" class="mt-3"></div>
  </div>

  <!-- Step 3: Attendance -->
  <div class="card p-3 mb-3">
    <h5>Step 3: Mark Attendance</h5>

    <div class="form-check mb-2">
      <input type="checkbox" class="form-check-input" id="in-time" disabled/>
      <label class="form-check-label" for="in-time">In Time</label>
    </div>

    <div class="form-check mb-2">
      <input type="checkbox" class="form-check-input" id="out-time" disabled/>
      <label class="form-check-label" for="out-time">Out Time</label>
    </div>

    <button id="btn-mark-attendance" class="btn btn-primary w-100 mt-2" disabled>Mark Attendance</button>
    <div id="attendance-status" class="mt-3"></div>
  </div>
</div>

<script>
let otpVerified = false;
let currentLat = null, currentLng = null;

// ‚≠ê Step 1 ‚Äî GPS Validation (Backend Connected)
$('#btn-gps').click(function(){
  $('#gps-status').text('Getting location...');

  navigator.geolocation.getCurrentPosition(async function(position){
    currentLat = position.coords.latitude;
    currentLng = position.coords.longitude;

    // üî• SEND to backend /validate_gps
    const res = await fetch("/validate_gps", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ lat: currentLat, lng: currentLng })
    });

    const data = await res.json();

    if(res.ok && data.success){
      $('#gps-status').html(`
        <span class="text-success">
          GPS validated ‚úîÔ∏è <br>
          Distance: ${data.distance.toFixed(2)} meters
        </span>
      `);
      $('#btn-send-otp').prop('disabled', false);
    } else {
      $('#gps-status').html(`
        <span class="text-danger">
          GPS Error ‚ùå <br>${data.message}
        </span>
      `);

      $('#btn-send-otp').prop('disabled', true);
      $('#otp-input').prop('disabled', true);
      $('#btn-verify-otp').prop('disabled', true);
    }

  }, function(err){
    $('#gps-status').html(`<span class="text-danger">${err.message}</span>`);
  });
});

// ‚≠ê Step 2 ‚Äî Send OTP
$('#btn-send-otp').click(function() {
  $('#otp-status').text('Sending OTP...');
  $.post('/send_otp').done(function(data) {
    $('#otp-status').text(data.message || "OTP sent!");
    $('#otp-input, #btn-verify-otp').prop('disabled', false);
  }).fail(function() {
    $('#otp-status').text('Failed to send OTP, try again.');
  });
});

$('#btn-verify-otp').click(function() {
  let otpVal = $('#otp-input').val().trim();
  if (!otpVal) {
    $('#otp-status').text('Please enter OTP');
    return;
  }
  $.post('/verify_otp', { otp: otpVal }).done(function(data) {
    if (data.success) {
      $('#otp-status').text('OTP verified: Success');
      otpVerified = true;
      $('#in-time, #out-time, #btn-mark-attendance').prop('disabled', false);
    } else {
      $('#otp-status').text(data.message || 'OTP verification failed.');
      otpVerified = false;
      $('#in-time, #out-time, #btn-mark-attendance').prop('disabled', true);
    }
  }).fail(function() {
    $('#otp-status').text('OTP verification failed (server error).');
  });
});


// ‚≠ê Attendance Input Handlers
$('#in-time').change(function(){
  if(this.checked) this.value = new Date().toLocaleTimeString();
  else this.value = '';
});

$('#out-time').change(function(){
  if(this.checked) this.value = new Date().toLocaleTimeString();
  else this.value = '';
});

// ‚≠ê Step 4 ‚Äî Mark Attendance
$('#btn-mark-attendance').click(function(){
  if(!otpVerified){
    $('#attendance-status').text('Please verify OTP first.');
    return;
  }

  const payload = {
    gps_location: { lat: currentLat, lng: currentLng },
    otp_verified: true
  };

  if($('#in-time').is(':checked')) payload.in_time = $('#in-time').val();
  if($('#out-time').is(':checked')) payload.out_time = $('#out-time').val();

  $.ajax({
    url: '/mark_attendance',
    type: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(payload),
    success: function(data){
      $('#attendance-status').html(`<span class="text-success">${data.message}</span>`);
      $('#in-time, #out-time').prop('checked', false).val('');
      otpVerified = false;

      $('#btn-send-otp, #otp-input, #btn-verify-otp, #btn-mark-attendance').prop('disabled', true);
      $('#gps-status, #otp-status').text('');
    },
    error: function(xhr){
      $('#attendance-status').html(`<span class="text-danger">${xhr.responseJSON?.message || 'Failed to mark attendance.'}</span>`);
    }
  });
});
</script>

</body>
</html>
